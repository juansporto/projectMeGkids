<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Gerenciar Vendas</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f8d7da;
        }
        .navbar {
            background-color: #c2185b;
        }
        .nav-link, .navbar-brand {
            color: white !important;
        }
        .btn-rosa {
            background-color: #c2185b;
            color: white;
        }
        .btn-rosa:hover {
            background-color: #a0174a;
            color: white;
        }
        .total-box {
            font-size: 1.5em;
            font-weight: bold;
            color: #c2185b;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
        <a class="navbar-brand" th:href="@{/admin/dashboard}">Painel do Gerente</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" th:href="@{/admin/clientes}">Clientes</a></li>
                <li class="nav-item"><a class="nav-link" th:href="@{/admin/produtos}">Produtos (Completo)</a></li>
                <li class="nav-item"><a class="nav-link" th:href="@{/admin/estoque}">Estoque (Simplificado)</a></li>
                <li class="nav-item"><a class="nav-link" th:href="@{/admin/movimentacoes}">Movimentações</a></li>
                <li class="nav-item"><a class="nav-link" th:href="@{/admin/vendas}">Vendas</a></li> <li class="nav-item"><a class="nav-link" th:href="@{/logout}">Logout</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <h2 class="text-center mb-4">Gerenciamento de Vendas</h2>

    <div class="card bg-white p-4 mb-4">
        <h4 class="mb-3">Registrar Nova Venda</h4>
        <form id="formVenda">
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="clienteId" class="form-label">Cliente</label>
                    <select class="form-select" id="clienteId" required>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="formaPagamento" class="form-label">Forma de Pagamento</label>
                    <input type="text" class="form-control" id="formaPagamento" required placeholder="Ex: Cartão, Dinheiro, Pix">
                </div>
            </div>

            <h5 class="mt-4 mb-3">Adicionar Produtos</h5>
            <div class="row g-3 align-items-end mb-4">
                <div class="col-md-6">
                    <label for="produtoParaAdicionar" class="form-label">Produto</label>
                    <select class="form-select" id="produtoParaAdicionar">
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="quantidadeProduto" class="form-label">Quantidade</label>
                    <input type="number" class="form-control" id="quantidadeProduto" min="1" value="1">
                </div>
                <div class="col-md-3">
                    <button type="button" class="btn btn-primary w-100" id="adicionarProdutoBtn">Adicionar</button>
                </div>
            </div>

            <h5 class="mb-3">Itens da Venda</h5>
            <table class="table table-bordered bg-light">
                <thead>
                <tr>
                    <th>Produto</th>
                    <th>Preço Unitário</th>
                    <th>Quantidade</th>
                    <th>Subtotal</th>
                    <th>Ações</th>
                </tr>
                </thead>
                <tbody id="itensVendaBody">
                <tr><td colspan="5" class="text-center">Nenhum item adicionado.</td></tr>
                </tbody>
                <tfoot>
                <tr>
                    <td colspan="3" class="text-end"><strong>Valor Total:</strong></td>
                    <td colspan="2" class="total-box"><span id="valorTotalVenda">R$ 0,00</span></td>
                </tr>
                </tfoot>
            </table>

            <div class="text-end mt-4">
                <button type="submit" class="btn btn-rosa btn-lg">Finalizar Venda</button>
            </div>
        </form>
        <div id="mensagemVenda" class="mt-3"></div>
    </div>

    <h3 class="mt-5 mb-3">Histórico de Vendas</h3>
    <table class="table table-striped table-bordered bg-white">
        <thead class="table-dark">
        <tr>
            <th>ID Venda</th>
            <th>Cliente</th>
            <th>Vendedor</th>
            <th>Data</th>
            <th>Forma Pgto.</th>
            <th>Valor Total</th>
            <th>Detalhes</th>
            <th>Ações</th>
        </tr>
        </thead>
        <tbody id="tabelaVendasBody">
        <tr><td colspan="8" class="text-center">Carregando vendas...</td></tr>
        </tbody>
    </table>

    <div class="modal fade" id="detalhesVendaModal" tabindex="-1" aria-labelledby="detalhesVendaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detalhesVendaModalLabel">Detalhes da Venda #<span id="vendaDetalhesId"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Cliente:</strong> <span id="detalhesCliente"></span></p>
                    <p><strong>Vendedor:</strong> <span id="detalhesVendedor"></span></p>
                    <p><strong>Data da Venda:</strong> <span id="detalhesData"></span></p>
                    <p><strong>Forma de Pagamento:</strong> <span id="detalhesFormaPgto"></span></p>
                    <p><strong>Valor Total:</strong> <span id="detalhesValorTotal"></span></p>
                    <h6 class="mt-4">Itens da Venda:</h6>
                    <table class="table table-bordered">
                        <thead>
                        <tr>
                            <th>Produto</th>
                            <th>Preço Unitário</th>
                            <th>Quantidade</th>
                            <th>Subtotal</th>
                        </tr>
                        </thead>
                        <tbody id="detalhesItensBody">
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    const API_BASE_URL = /*[[@{/}]]*/ '';
    const VENDAS_API_URL = API_BASE_URL + 'vendas';
    // Precisamos de um API RESTful para Clientes para o dropdown. Se seu ClienteControle NÃO é @RestController,
    // você precisará criar um ClienteApiControle, similar ao ProdutoApiControle.
    const CLIENTES_API_URL = API_BASE_URL + 'api/clientes'; // Assumindo /api/clientes
    const PRODUTOS_API_URL = API_BASE_URL + 'api/produtos'; // Sua API REST para Produtos

    // AVISO: PARA FINS DE EXEMPLO, O usuarioId ESTÁ FIXO.
    // Em um sistema real, o usuarioId viria do usuário autenticado no backend (ex: através de Spring Security).
    const CURRENT_USER_ID = 1; // Substitua pela lógica real de obtenção do ID do usuário logado

    let itensNoCarrinho = []; // Array para armazenar os produtos adicionados à venda

    document.addEventListener('DOMContentLoaded', () => {
        carregarClientesParaDropdown();
        carregarProdutosParaAdicionar();
        carregarVendas(); // Carrega o histórico de vendas

        // Evento para adicionar produto ao carrinho
        document.getElementById('adicionarProdutoBtn').addEventListener('click', adicionarProdutoAoCarrinho);

        // Evento para finalizar a venda
        document.getElementById('formVenda').addEventListener('submit', finalizarVenda);
    });

    async function carregarClientesParaDropdown() {
        const selectCliente = document.getElementById('clienteId');
        selectCliente.innerHTML = '<option value="">Carregando clientes...</option>';

        try {
            // Se seu ClienteControle NÃO é um @RestController, você precisará criar um ClienteApiControle.
            const response = await fetch(CLIENTES_API_URL);
            if (!response.ok) {
                throw new Error('Erro ao carregar clientes.');
            }
            const clientes = await response.json();

            selectCliente.innerHTML = '<option value="">Selecione um Cliente</option>';
            clientes.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.id;
                option.textContent = cliente.nome;
                selectCliente.appendChild(option);
            });
        } catch (error) {
            console.error('Erro ao carregar clientes:', error);
            selectCliente.innerHTML = '<option value="">Erro ao carregar clientes</option>';
            mostrarMensagemVenda('Erro ao carregar lista de clientes.', 'danger');
        }
    }

    async function carregarProdutosParaAdicionar() {
        const selectProduto = document.getElementById('produtoParaAdicionar');
        selectProduto.innerHTML = '<option value="">Carregando produtos...</option>';

        try {
            const response = await fetch(PRODUTOS_API_URL);
            if (!response.ok) {
                throw new Error('Erro ao carregar produtos.');
            }
            const produtos = await response.json();

            selectProduto.innerHTML = '<option value="">Selecione um Produto</option>';
            produtos.forEach(produto => {
                const option = document.createElement('option');
                option.value = produto.id;
                option.setAttribute('data-nome', produto.nome);
                option.setAttribute('data-preco', produto.preco);
                option.setAttribute('data-estoque', produto.quantidadeEstoque);
                option.textContent = `${produto.nome} (Estoque: ${produto.quantidadeEstoque}, R$ ${produto.preco.toFixed(2)})`;
                selectProduto.appendChild(option);
            });
        } catch (error) {
            console.error('Erro ao carregar produtos:', error);
            selectProduto.innerHTML = '<option value="">Erro ao carregar produtos</option>';
            mostrarMensagemVenda('Erro ao carregar lista de produtos.', 'danger');
        }
    }

    function adicionarProdutoAoCarrinho() {
        const selectProdutoElem = document.getElementById('produtoParaAdicionar');
        const quantidadeInput = document.getElementById('quantidadeProduto');

        const produtoId = selectProdutoElem.value;
        const quantidade = parseInt(quantidadeInput.value);

        if (!produtoId) {
            mostrarMensagemVenda('Selecione um produto para adicionar.', 'warning');
            return;
        }
        if (isNaN(quantidade) || quantidade <= 0) {
            mostrarMensagemVenda('A quantidade deve ser um número positivo.', 'warning');
            return;
        }

        const selectedOption = selectProdutoElem.options[selectProdutoElem.selectedIndex];
        const nomeProduto = selectedOption.getAttribute('data-nome');
        const precoUnitario = parseFloat(selectedOption.getAttribute('data-preco'));
        const estoqueDisponivel = parseInt(selectedOption.getAttribute('data-estoque'));

        // Verifica se o produto já está no carrinho e se a quantidade não excede o estoque
        const itemExistenteIndex = itensNoCarrinho.findIndex(item => item.produtoId === parseInt(produtoId));

        if (itemExistenteIndex !== -1) {
            // Se o item já está no carrinho, atualiza a quantidade
            const novaQuantidadeTotal = itensNoCarrinho[itemExistenteIndex].quantidade + quantidade;
            if (novaQuantidadeTotal > estoqueDisponivel) {
                mostrarMensagemVenda(`Quantidade total para ${nomeProduto} excede o estoque disponível (${estoqueDisponivel}).`, 'danger');
                return;
            }
            itensNoCarrinho[itemExistenteIndex].quantidade = novaQuantidadeTotal;
            itensNoCarrinho[itemExistenteIndex].subTotal = precoUnitario * novaQuantidadeTotal;
        } else {
            // Se é um novo item, verifica o estoque inicial
            if (quantidade > estoqueDisponivel) {
                mostrarMensagemVenda(`Quantidade solicitada para ${nomeProduto} excede o estoque disponível (${estoqueDisponivel}).`, 'danger');
                return;
            }
            itensNoCarrinho.push({
                produtoId: parseInt(produtoId),
                nome: nomeProduto,
                precoUnitario: precoUnitario,
                quantidade: quantidade,
                subTotal: precoUnitario * quantidade
            });
        }

        renderizarItensDoCarrinho();
        calcularValorTotalVenda();
        quantidadeInput.value = 1; // Reseta a quantidade para 1
        selectProdutoElem.value = ""; // Limpa a seleção do produto
    }

    function removerProdutoDoCarrinho(index) {
        itensNoCarrinho.splice(index, 1);
        renderizarItensDoCarrinho();
        calcularValorTotalVenda();
    }

    function renderizarItensDoCarrinho() {
        const itensVendaBody = document.getElementById('itensVendaBody');
        itensVendaBody.innerHTML = ''; // Limpa a tabela

        if (itensNoCarrinho.length === 0) {
            itensVendaBody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum item adicionado.</td></tr>';
            return;
        }

        itensNoCarrinho.forEach((item, index) => {
            const row = itensVendaBody.insertRow();
            row.insertCell().textContent = item.nome;
            row.insertCell().textContent = `R$ ${item.precoUnitario.toFixed(2)}`;
            row.insertCell().textContent = item.quantidade;
            row.insertCell().textContent = `R$ ${item.subTotal.toFixed(2)}`;

            const acoesCell = row.insertCell();
            const removerBtn = document.createElement('button');
            removerBtn.className = 'btn btn-danger btn-sm';
            removerBtn.textContent = 'Remover';
            removerBtn.onclick = () => removerProdutoDoCarrinho(index);
            acoesCell.appendChild(removerBtn);
        });
    }

    function calcularValorTotalVenda() {
        const valorTotalElement = document.getElementById('valorTotalVenda');
        const total = itensNoCarrinho.reduce((sum, item) => sum + item.subTotal, 0);
        valorTotalElement.textContent = `R$ ${total.toFixed(2)}`;
    }

    async function finalizarVenda(event) {
        event.preventDefault();

        const clienteId = document.getElementById('clienteId').value;
        const formaPagamento = document.getElementById('formaPagamento').value.trim();

        if (!clienteId || !formaPagamento) {
            mostrarMensagemVenda('Preencha o cliente e a forma de pagamento.', 'danger');
            return;
        }
        if (itensNoCarrinho.length === 0) {
            mostrarMensagemVenda('Adicione pelo menos um item à venda.', 'danger');
            return;
        }

        const vendaPayload = {
            clienteId: parseInt(clienteId),
            usuarioId: CURRENT_USER_ID,
            formaPagamento: formaPagamento,
            itens: itensNoCarrinho.map(item => ({
                produtoId: item.produtoId,
                quantidade: item.quantidade
                // precoUnitario e subTotal são calculados no backend
            }))
        };

        try {
            const response = await fetch(VENDAS_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(vendaPayload)
            });

            const resultado = await response.json();

            if (response.ok) {
                mostrarMensagemVenda('Venda registrada com sucesso!', 'success');
                // Limpa o formulário e o carrinho
                document.getElementById('formVenda').reset();
                itensNoCarrinho = [];
                renderizarItensDoCarrinho();
                calcularValorTotalVenda();
                carregarVendas(); // Recarrega a tabela de histórico de vendas
            } else {
                mostrarMensagemVenda(`Erro ao registrar venda: ${resultado.message || response.statusText}`, 'danger');
            }
        } catch (error) {
            console.error('Erro de rede ou ao processar requisição de venda:', error);
            mostrarMensagemVenda('Erro de conexão ou processamento ao finalizar venda.', 'danger');
        }
    }

    async function carregarVendas() {
        const tabelaVendasBody = document.getElementById('tabelaVendasBody');
        tabelaVendasBody.innerHTML = '<tr><td colspan="8" class="text-center">Carregando vendas...</td></tr>';

        try {
            const response = await fetch(VENDAS_API_URL);
            if (!response.ok) {
                throw new Error('Erro ao carregar vendas.');
            }
            const vendas = await response.json();

            tabelaVendasBody.innerHTML = ''; // Limpa a tabela
            if (vendas.length === 0) {
                tabelaVendasBody.innerHTML = '<tr><td colspan="8" class="text-center">Nenhuma venda registrada.</td></tr>';
                return;
            }

            for (const venda of vendas) {
                const row = tabelaVendasBody.insertRow();
                row.insertCell().textContent = venda.id;

                // Para obter Nome do Cliente e Vendedor, precisaremos de mais requisições
                // ou ajustar os DTOs de Venda para incluir esses nomes.
                // Por agora, exibimos os IDs.
                // ALTERNATIVA: Criar API REST para Clientes/Usuários para buscar por ID.
                const clienteNome = await getNomeCliente(venda.clienteId);
                const usuarioNome = await getNomeUsuario(venda.usuarioId);

                row.insertCell().textContent = clienteNome;
                row.insertCell().textContent = usuarioNome;
                row.insertCell().textContent = venda.dataVenda; // Data já formatada no backend
                row.insertCell().textContent = venda.formaPagamento;
                row.insertCell().textContent = `R$ ${venda.valorTotal.toFixed(2)}`;

                const detalhesCell = row.insertCell();
                const detalhesBtn = document.createElement('button');
                detalhesBtn.className = 'btn btn-info btn-sm';
                detalhesBtn.textContent = 'Ver Detalhes';
                detalhesBtn.onclick = () => exibirDetalhesVenda(venda); // Passa o objeto venda
                detalhesCell.appendChild(detalhesBtn);

                const acoesCell = row.insertCell();
                const deletarBtn = document.createElement('button');
                deletarBtn.className = 'btn btn-danger btn-sm';
                deletarBtn.textContent = 'Excluir';
                deletarBtn.onclick = () => deletarVenda(venda.id);
                acoesCell.appendChild(deletarBtn);
            }
        } catch (error) {
            console.error('Erro ao carregar vendas:', error);
            tabelaVendasBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Erro ao carregar histórico de vendas.</td></tr>';
        }
    }

    async function getNomeCliente(clienteId) {
        if (!clienteId) return 'N/A';
        try {
            const response = await fetch(`${API_BASE_URL}api/clientes/${clienteId}`);
            if (!response.ok) throw new Error('Cliente não encontrado.');
            const cliente = await response.json();
            return cliente.nome;
        } catch (error) {
            console.warn(`Não foi possível carregar o nome do cliente ID ${clienteId}:`, error);
            return `ID: ${clienteId}`;
        }
    }

    async function getNomeUsuario(usuarioId) {
        if (!usuarioId) return 'N/A';
        try {
            // Você precisará de uma API REST para Usuários. Ex: /api/usuarios/{id}
            const response = await fetch(`${API_BASE_URL}api/usuarios/${usuarioId}`);
            if (!response.ok) throw new Error('Usuário não encontrado.');
            const usuario = await response.json();
            return usuario.nome; // Assumindo que a entidade Usuario tem um campo 'nome'
        } catch (error) {
            console.warn(`Não foi possível carregar o nome do usuário ID ${usuarioId}:`, error);
            return `ID: ${usuarioId}`;
        }
    }

    async function exibirDetalhesVenda(venda) {
        document.getElementById('vendaDetalhesId').textContent = venda.id;
        document.getElementById('detalhesCliente').textContent = await getNomeCliente(venda.clienteId);
        document.getElementById('detalhesVendedor').textContent = await getNomeUsuario(venda.usuarioId);
        document.getElementById('detalhesData').textContent = venda.dataVenda;
        document.getElementById('detalhesFormaPgto').textContent = venda.formaPagamento;
        document.getElementById('detalhesValorTotal').textContent = `R$ ${venda.valorTotal.toFixed(2)}`;

        const detalhesItensBody = document.getElementById('detalhesItensBody');
        detalhesItensBody.innerHTML = '';

        if (venda.itens && venda.itens.length > 0) {
            for (const item of venda.itens) {
                const row = detalhesItensBody.insertRow();
                const produtoNome = await getNomeProduto(item.produtoId); // Você precisará desta função
                row.insertCell().textContent = produtoNome;
                row.insertCell().textContent = `R$ ${item.precoUnitario ? item.precoUnitario.toFixed(2) : '0.00'}`;
                row.insertCell().textContent = item.quantidade;
                row.insertCell().textContent = `R$ ${item.subTotal ? item.subTotal.toFixed(2) : '0.00'}`;
            }
        } else {
            detalhesItensBody.innerHTML = '<tr><td colspan="4" class="text-center">Nenhum item.</td></tr>';
        }

        const modal = new bootstrap.Modal(document.getElementById('detalhesVendaModal'));
        modal.show();
    }

    async function getNomeProduto(produtoId) {
        if (!produtoId) return 'N/A';
        try {
            // Usando sua API de produtos existente para buscar um único produto
            const response = await fetch(`${PRODUTOS_API_URL}/${produtoId}`);
            if (!response.ok) throw new Error('Produto não encontrado.');
            const produto = await response.json();
            return produto.nome;
        } catch (error) {
            console.warn(`Não foi possível carregar o nome do produto ID ${produtoId}:`, error);
            return `ID: ${produtoId}`;
        }
    }

    async function deletarVenda(id) {
        if (!confirm('Tem certeza que deseja excluir esta venda? Esta ação reverterá o estoque.')) {
            return;
        }

        try {
            const response = await fetch(`${VENDAS_API_URL}/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                mostrarMensagemVenda('Venda excluída e estoque revertido com sucesso!', 'success');
                carregarVendas(); // Recarrega o histórico
            } else {
                const errorText = await response.text(); // Lê o corpo da resposta para erros
                mostrarMensagemVenda(`Erro ao excluir venda: ${errorText || response.statusText}`, 'danger');
            }
        } catch (error) {
            console.error('Erro de rede ou ao processar requisição de exclusão:', error);
            mostrarMensagemVenda('Erro de conexão ou processamento ao excluir venda.', 'danger');
        }
    }

    function mostrarMensagemVenda(texto, tipo) {
        const mensagemDiv = document.getElementById('mensagemVenda');
        mensagemDiv.innerHTML = `<div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
                                    ${texto}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>`;
    }
</script>
</body>
</html>